Максим, доброго времени суток!
Замечания исправил.
Сделал две функции:
1) для соединения моделей(таблиц)
2) для фильтрации, с доп.фильрацией при необходимости.

